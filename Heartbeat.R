####
#### Function to compute the heartbeat of some data
#### Author: Rafael Prieto Curiel rafael.prieto.13@ucl.ac.uk
####
#### Input: Time of the events, provided as a single number
####        where the number 43831.0 represents Wednesday 01/01/2020
####        the integer part represents the day and the decimal part
####        of the number represents the time of the day, so that
####        43831.50 is Wednesday 01/01/2020 at 12:00
####        43831.25 is Wednesday 01/01/2020 at 6:00, and
####        43831.75 is Wednesday 01/01/2020 at 18:00
####
#### Output: The heartbeat of the events, smoothed with a cyclic KDE
####         computed for a vector of length 1024. 
####         The first entry corresponds to Monday at 0:00
####         The entry 100 corresponds to Monday at 16:24, and
####         The entry 147 corresponds to Tuesday at 0:07 
library(pracma)
Heartbeat <- function(DATE){
  DATE <- DATE[!is.na(DATE)]
  Day <- DATE - floor(DATE) + mod(floor(DATE)-1, 7)
  D <- density(c(Day, Day-7, Day+7),
               from = 1, to = 8,
               n = 1024,
               bw = 8/(24*7))
    return(D$y*length(DATE))
  }

#### Example 1 (7 data points)
H <- Heartbeat(c(2.6, 2.5, 4.6, 9.4, 14.4, 21, 24.2))
plot(H, type = "l",
     xlab = "Time of the week",
     xaxt = "n",
     lwd = 3, col = 2,
     ylab  = "Heartbeat")
for(k in 0:6){
  for(j in 0:23){points(c(1024*k/7,1024*k/7) + 1024/7*j/24, c(0, 100000), 
                        type = "l", col = "gray", lwd = .5)}
  points(c(1024*k/7,1024*k/7), c(-100000, 100000), 
         type = "l", col = 1, lwd = 3)
  
};   points(c(1024,1024), c(-100000, 100000), 
            type = "l", col = 1, lwd = 3)
axis(1, at = 1024*c(1:7 - 0.5)/7, 
     labels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))

#### Example 2 (200 data points)
s <- c(
  42611.66, 42559.39, 43526.74, 43252.34, 
  42139.97, 42169.44, 43024.76, 42512.83, 
  43521.68, 42146.96, 42804.81, 42688.54, 
  41920.93, 43546.77, 43452.92, 41890.64, 
  43251.61, 43132.44, 42216.51, 41643.59, 
  43160.91, 43521.62, 41718.41, 42550.45, 
  43113.78, 43194.76, 42447.58, 42236.84, 
  43345.03, 42345.62, 42594.89, 42566.38, 
  43506.88, 42332.63, 43224.73, 42514.37, 
  42710.65, 42870.67, 43105.42, 42956.39, 
  43109.75, 42528.36, 43505.51, 42710.62, 
  41777.99, 43477.78, 42632.16, 43243.31, 
  42357.11, 42487.64, 42969.93, 42603.06, 
  42751.42, 43147.64, 42768.65, 42163.84, 
  42209.78, 42164.39, 42392.19, 43314.73, 
  42751.63, 43286.27, 42597.43, 43306.77, 
  43215.78, 42413.83, 43304.82, 42372.73, 
  41686.84, 43219.77, 42617.05, 43308.64, 
  41908.98, 42958.09, 42903.91, 43171.37, 
  43474.85, 43177.16, 42289.63, 42612.35, 
  41835.73, 43500.84, 42350.85, 42115.65, 
  43243.31, 42834.45, 43007.98, 43289.56, 
  42902.96, 41846.69, 42236.72, 42356.95, 
  42691.93, 42061.83, 41832.17, 43026.64, 
  41725.66, 42345.78, 42142.63, 42833.91, 
  42858.56, 42165.85, 41948.77, 43201.67, 
  43513.53, 42486.82, 42766.01, 41884.63, 
  43071.61, 41842.64, 43290.79, 42958.93, 
  43050.85, 43125.55, 42891.24, 41892.62, 
  43181.93, 42649.65, 42403.58, 42198.58, 
  43078.42, 43228.99, 42329.65, 42606.51, 
  42446.33, 43253.26, 42690.74, 41914.79, 
  42988.09, 42649.91, 43023.44, 42052.04, 
  42952.67, 42266.77, 43065.82, 43133.75, 
  43363.36, 41663.68, 41685.55, 42763.19, 
  43150.65, 43181.35, 41915.72, 42946.91, 
  42996.42, 41881.61, 43467.92, 42501.31, 
  42983.44, 42937.46, 43333.49, 42109.78, 
  43391.36, 42559.64, 42811.88, 42516.89, 
  42147.52, 42655.94, 43373.94, 42874.93, 
  43277.92, 42306.88, 42507.57, 43472.54, 
  42600.71, 43211.88, 42244.84, 43255.36, 
  42378.56, 42432.91, 42572.65, 43458.73, 
  41784.74, 42820.66, 42176.26, 43309.87, 
  43158.46, 42174.76, 43114.14, 42030.53, 
  41787.79, 43156.78, 42567.32, 41682.73, 
  42269.77, 42593.16, 42620.69, 43239.91, 
  43389.01, 43253.76, 42778.11, 42928.62, 
  42261.34, 42444.57, 42341.81, 41802.99, 
  41708.48, 42459.74, 42517.73, 42667.51
)
H <- Heartbeat(s)
plot(H, type = "l",
     xlab = "Time of the week",
     xaxt = "n",
     lwd = 3, col = 2,
     ylab  = "Heartbeat")
for(k in 0:6){
  for(j in 0:23){points(c(1024*k/7,1024*k/7) + 1024/7*j/24, c(0, 100000), 
                        type = "l", col = "gray", lwd = .5)}
  points(c(1024*k/7,1024*k/7), c(-100000, 100000), 
         type = "l", col = 1, lwd = 3)
  
};   points(c(1024,1024), c(-100000, 100000), 
            type = "l", col = 1, lwd = 3)
axis(1, at = 1024*c(1:7 - 0.5)/7, 
     labels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))
